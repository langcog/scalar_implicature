---
title: "Scalar_M1"
author: "BPeloquin"
date: "April 23, 2015"
output: html_document
---

Preliminaries.

```{r}
rm(list=ls())
source("analysis/useful_dplyr.R")
library(rjson)
```

## Notes
* <none, some, all> condition: the model correctly produces implicature.
* However "all"" condition is predicted to be compabitible with a 4 rating.
* This appears to be driven by several factors
  * 1) High priors over 4
  * 2) Fairly high compabitibiliy with All and four stars from e5

## Basic form of the model

$$ p_{L_p} (r \mid u) \propto \frac{p_S(u | r) p_{L_0}(r)}{\sum_{u' \in alts}{p_S(u' \mid r) p_{L_0}(r)}}$$

Read Data 
---------

```{r}
priors = read.csv("models/prior.csv")
speaker = read.csv("models/speaker.csv")
listener = read.csv("models/listener.csv")
```

## MODEL IMPLEMENTATION

Key:
* u = utterance [string]
* alts = alternative utterances
* r = rating index [1-5]
* d.info = informativity judgements

```{r}
#cost function in length of chars
u.cost = function(u) {
  return(nchar(u))
}

#speaker likelihood helper 
#speaker.lhd = function(utt, info, alpha) {
#  exp(alpha*(log(info) - 3)) #Rething cost??? 
#}
speaker.lhd = function(d) {
  exp(4*(log(d) - 3)) #Rethink alpha and costs?
}

#speaker likelihood normalized
speaker.prob = function(rating, degree, m) {
  num = speaker.lhd(m[rating, degree])
  norm = 0
  for ( i in 1:2 ) {
    norm = norm + speaker.lhd(m[rating, i])
  }
  return(num / norm)
}

#non-normalized posterior
nn.post = function(rating, degree, m) {
  return(speaker.prob(rating, degree, m) * priors[rating, "prior.p"])
}

#normalized posterior
norm.post = function(rating, degree, m) {
  nn = nn.post(rating, degree, m)
  norm = 0
  for (i in 1:5) {
    norm = norm + nn.post(i, degree, m)
  }
  return(nn / norm)
}  
```

model wrapper functions:

```{r}
run.rsa <- function(d) {
  #BP------->
  #Get current matrix
  get.m = function(s, m) {
    m2 <- filter(m, scale == s) %>%
      spread(degree, speaker.p) %>%
      mutate(hi = hi / sum(hi), 
                  low = low / sum(low)) %>%
      select(hi, low)
    return(m2)
  }
  
  scale.matrix <- data %>% 
    select(stars, degree, speaker.p, prior.p) %>%
    mutate(listener.pred = norm.post(stars, degree, get.m(scale, .)))
  
  #return scale.matrx$
 #BP------->
  
  #Old Mike code------>
  scale.matrix <- data %>% 
    select(stars, degree, speaker.p, prior.p) %>% 
    spread(degree, speaker.p) %>% 
    mutate(hi = hi / sum(hi), 
           low = low / sum(low)) %>%
    as.matrix
  
  preds <- expand.grid(stars = 1:5, 
              degree = c("low","hi")) %>%
  
    scale.matrix %>% 
    mutate(listener.pred = norm.post(stars, degree, get.m(scale, scale.matrix)))
  return(preds)
} 
```


RUN MODEL
--------

Run model on actual data

```{r}
data <- left_join(speaker, listener) %>%
  left_join(priors) %>%
  rowwise %>%
  select(scale, degree, stars, speaker.p, listener.p, prior.p) %>%
  mutate(listener.p = ifelse(is.na(listener.p), 0, listener.p)) %>%
  group_by(scale) %>%
  do(model.preds = run.rsa(.))

```


## DATA / PLOTS

Priors
```{r}
qplot(c(1:5), priors$prior.p,
      geom="bar", stat = "identity",
      binwidth = 1, main="Priors over ratings")
```

SOME
```{r}
d.some.unif.priors = sapply(1:5, FUN=function(i){
  norm.post("some", i, scale.matrix, unif.priors)})
d.some.raw.priors = sapply(1:5, FUN=function(i){
  norm.post("some", i, scale.matrix, raw.priors)})

qplot(c(1:5), d.some.raw.priors,
      geom="bar", stat = "identity",
      binwidth = 1, main="Some Posteriors")
```

ALL
```{r}
d.all.raw.priors = sapply(1:5, FUN=function(i){
  norm.post("all", i, scale.matrix, raw.priors)})
d.all.unif.priors = sapply(1:5, FUN=function(i){
  norm.post("all", i, n.scale.matrix, unif.priors)})

qplot(c(1:5), d.all.raw.priors,
      geom="bar", stat = "identity",
      binwidth = 1, main="All Posteriors, Raw priors")
```

